using SkiaSharp;
using ShareX.Editor.Helpers;

namespace ShareX.Editor.ImageEffects.Manipulations;

public class AutoCropImageEffect : ImageEffect
{
    private SKColor _color;
    private int _tolerance;
    
    public override string Name => "Auto crop image";
    public override ImageEffectCategory Category => ImageEffectCategory.Manipulations;

    public SKColor Color
    {
        get => _color;
        set => _color = value;
    }

    public int Tolerance
    {
        get => _tolerance;
        set => _tolerance = value;
    }

    public AutoCropImageEffect(SKColor color, int tolerance = 0)
    {
        _color = color;
        _tolerance = tolerance;
    }

    public AutoCropImageEffect()
    {
        _color = SKColors.Transparent;
    }

    public override SKBitmap Apply(SKBitmap source)
    {
        if (source is null) throw new ArgumentNullException(nameof(source));

        int width = source.Width;
        int height = source.Height;

        int minX = width, minY = height, maxX = 0, maxY = 0;
        bool hasContent = false;

        for (int y = 0; y < height; y++)
        {
            for (int x = 0; x < width; x++)
            {
                SKColor pixel = source.GetPixel(x, y);
                if (!ImageHelpers.ColorsMatch(pixel, _color, _tolerance))
                {
                    hasContent = true;
                    if (x < minX) minX = x;
                    if (x > maxX) maxX = x;
                    if (y < minY) minY = y;
                    if (y > maxY) maxY = y;
                }
            }
        }

        if (!hasContent)
        {
            return new SKBitmap(1, 1, source.ColorType, source.AlphaType);
        }

        int cropWidth = maxX - minX + 1;
        int cropHeight = maxY - minY + 1;

        return ImageHelpers.Crop(source, minX, minY, cropWidth, cropHeight);
    }
}

